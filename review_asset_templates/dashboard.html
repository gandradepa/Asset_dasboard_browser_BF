<!DOCTYPE html>
<html>
<head>
    <title>Asset Review Dashboard - Backflow Devices</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <style>
        .type-badge {
            display: inline-block;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1;
        }
        .type-ME { background: #e7f3ff; color: #084298; }
        .type-EE { background: #e6ffed; color: #0a6b2d; }
        .type-EL { background: #fff3cd; color: #664d03; }
        .type-PL { background: #fde2e2; color: #842029; }
        .type-HV { background: #e8e6ff; color: #3d2b8c; }
        .type-OTHER { background: #f1f3f5; color: #333; }

        .filters-bar .form-select { min-width: 220px; }
        .filters-bar .badge { font-weight: 500; }
        td.approved-cell { cursor: pointer; user-select: none; }
        td.approved-cell:focus { outline: 2px solid #0d6efd33; }

        @media (max-width: 767.98px) {
          .dataTables_length,
          .dataTables_filter {
            display: flex;
            justify-content: flex-start;
          }
          .dataTables_length {
            margin-bottom: 0.5rem;
          }
        }
    </style>
</head>
<body class="container-fluid py-4">

    <div class="d-flex flex-column flex-sm-row justify-content-start align-items-sm-center text-center text-sm-start mb-4">
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='ubc-logo.png') }}" alt="UBC Logo" style="height: 72px; margin-right: 16px;">
        </a>
        <a href="{{ url_for('index') }}" style="text-decoration: none; color: black;">
            <h1 class="m-0">Asset Review Dashboard - Backflow Devices</h1>
        </a>
    </div>

    <div class="filters-bar row g-3 align-items-center mb-3">
        <div class="col-12 col-lg-auto text-start">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm px-3 {% if not flagged_filter and not modified_filter and not missed_filter %}active{% endif %}">All</a>
            <a href="{{ url_for('index', flagged='true') }}" class="btn btn-outline-danger btn-sm px-3 {% if flagged_filter == 'true' %}active{% endif %}"
               data-bs-toggle="tooltip" data-bs-placement="top" title="Flagged Only">
                üö© <span class="badge bg-light text-dark">{{ count_flagged }}</span>
            </a>
            <a href="{{ url_for('index', modified='true') }}" class="btn btn-outline-warning btn-sm px-3 {% if modified_filter == 'true' %}active{% endif %}"
               data-bs-toggle="tooltip" data-bs-placement="top" title="Modified Only">
                ‚úèÔ∏è <span class="badge bg-light text-dark">{{ count_modified }}</span>
            </a>
            <a href="{{ url_for('index', missed='true') }}" class="btn btn-outline-dark btn-sm px-3 {% if missed_filter == 'true' %}active{% endif %}"
               data-bs-toggle="tooltip" data-bs-placement="top" title="Missed Photo Only">
                üñºÔ∏è <span class="badge bg-light text-dark">{{ count_missed }}</span>
            </a>
        </div>

        <div class="col-12 col-lg-auto ms-lg-auto">
            <div class="row g-2">
                <div class="col-12 col-sm-6 col-lg-auto">
                    <label for="filter-building" class="form-label mb-1 small text-muted">Filter by Building</label>
                    <select id="filter-building" class="form-select form-select-sm">
                        <option value="">All Buildings</option>
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-lg-auto">
                    <label for="filter-approved" class="form-label mb-1 small text-muted">Filter by Approved</label>
                    <select id="filter-approved" class="form-select form-select-sm">
                        <option value="">All</option>
                        <option value="True">Approved Only</option>
                        <option value="False">Not Approved Only</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <table id="assetTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
        <thead class="table-dark">
            <tr>
                <th class="text-center">QR Code</th>
                <th class="text-center">Building</th>
                <th class="text-center">Type</th>
                <th class="text-start">Manufacturer</th>
                <th class="text-start">Model</th>
                <th class="text-start">Serial</th>
                <th class="text-start">UBC Tag</th>
                <th class="text-start">Asset Group</th>
                <th class="text-start">Attribute</th>
                <th class="text-start">Description</th>
                <th class="text-start">Diameter</th>
                <th class="text-center">Approved</th>
                <th class="text-center">Flagged</th>
                <th class="text-center">Modified</th>
                <th class="text-center">Missed Photo</th>
                <th class="text-center" data-priority="1">Action</th>
             </tr>
        </thead>
        <tbody>
        {% for item in data %}
            <tr>
                <td>{{ item.qr_code }}</td>
                <td>{{ item.building }}</td>
                <td>
                    <span class="type-badge"
                          data-type="{{ (item.asset_type or '') | upper | replace('-', '') | trim }}">
                        {{ (item.asset_type or '') | upper | replace('-', '') | trim }}
                    </span>
                </td>
                <td class="text-start">{{ item.Manufacturer }}</td>
                <td class="text-start">{{ item.Model }}</td>
                <td class="text-start">{{ item['Serial Number'] }}</td>
                <td class="text-start">{{ item['UBC Tag'] }}</td>
                <td class="text-start">{{ item['Asset Group'] }}</td>
                <td class="text-start">{{ item['Attribute'] }}</td>
                <td class="text-start">{{ item['Description'] }}</td>
                <td class="text-start">{{ item['Diameter'] }}</td>

                {% set approved_bool = 'True' if item['Approved'] == 'True' else 'False' %}
                <td class="approved-cell text-center" tabindex="0" role="button"
                    data-docid="{{ item.doc_id }}"
                    data-search="{{ approved_bool }}"
                    title="Click to toggle Approved">
                    {% if item['Approved'] == 'True' %}‚úÖ{% else %}‚òê{% endif %}
                </td>

                <td class="text-center">{% if item.Flagged == 'true' %}üö©{% else %}&mdash;{% endif %}</td>
                <td class="text-center">{% if item.Modified %}‚úèÔ∏è{% else %}&mdash;{% endif %}</td>
                <td class="text-center">
                  {% if item['Missed Photo'] == 'YES' %}
                    <span class="text-danger"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="Missing: {{ item['Missing List'] }}">
                      ‚ùå {{ item['Photos Summary'] }}
                    </span>
                  {% else %}
                    <span class="text-success"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="At least 2 of 3 present">
                      ‚úÖ {{ item['Photos Summary'] }}
                    </span>
                  {% endif %}
                </td>
                <td>
                    <a class="btn btn-primary btn-sm {% if item['Approved'] == 'True' %}disabled{% endif %}" href="{{ url_for('review', doc_id=item.doc_id) }}">Review</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <footer class="text-center mt-5 pt-4 border-top text-muted small">
        &copy; 2025 University of British Columbia - Maintenance Planning Department. All rights reserved.
    </footer>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="infoModalBody">
                    <!-- Dynamic message goes here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
      // Persist quick-filters across Review
      try { localStorage.setItem('dashboardQuery', window.location.search || ''); } catch (e) {}

      // Tooltips
      document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) })
      });

      $(document).ready(function () {
          var colBuilding = 1;
          var colApproved = 11;
          var colAction = 15;

          var table = $('#assetTable').DataTable({
              pageLength: 15,
              order: [],
              stateSave: true,
              stateDuration: -1,
              responsive: true,
              columnDefs: [
                  { orderable: false, targets: [colApproved, colAction] }
              ]
          });

          function populateBuilding() {
              var select = $('#filter-building');
              select.find('option:not(:first)').remove();
              var uniques = {};
              table.column(colBuilding, { search: 'applied' }).data().each(function (val) {
                  val = (val || '').toString().trim();
                  if (val) uniques[val] = true;
              });
              Object.keys(uniques).sort().forEach(function (v) {
                  select.append(new Option(v, v));
              });
          }
          populateBuilding();

          var state = table.state.loaded();
          if (state && state.columns) {
              var bSearch = state.columns[colBuilding]?.search?.search || '';
              if (bSearch.startsWith('^') && bSearch.endsWith('$')) {
                  bSearch = bSearch.slice(1, -1);
                  try { bSearch = $.fn.dataTable.util.unescapeRegex(bSearch); } catch(e) {}
              }
              if (bSearch) $('#filter-building').val(bSearch);

              var aSearch = state.columns[colApproved]?.search?.search || '';
              if (aSearch === '^True$') $('#filter-approved').val('True');
              else if (aSearch === '^False$') $('#filter-approved').val('False');
          }

          table.on('draw', function () {
              var current = $('#filter-building').val();
              populateBuilding();
              if (current) $('#filter-building').val(current);
          });

          $('#filter-building').on('change', function () {
              var val = $(this).val();
              table.column(colBuilding).search(val ? '^' + $.fn.dataTable.util.escapeRegex(val) + '$' : '', true, false).draw();
          });

          $('#filter-approved').on('change', function () {
              var v = $(this).val();
              table.column(colApproved).search(v ? `^${v}$` : '', true, false).draw();
          });

          $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
              if (settings.nTable !== $('#assetTable')[0]) return true;
              var search = settings.aoPreSearchCols[colApproved].sSearch;
              if (!search) return true;
              var td = settings.aoData[dataIndex].anCells[colApproved];
              var val = $(td).attr('data-search') || '';
              var regex = settings.aoPreSearchCols[colApproved].bRegex ? new RegExp(search) : null;
              return regex ? regex.test(val) : (val.indexOf(search) !== -1);
          });

          var infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
          var infoModalTitle = document.getElementById('infoModalLabel');
          var infoModalBody = document.getElementById('infoModalBody');

          function showModal(title, message) {
              infoModalTitle.textContent = title;
              infoModalBody.textContent = message;
              infoModal.show();
          }

          $('#assetTable').on('click keypress', '.approved-cell', function (e) {
              if (e.type === 'keypress' && (e.key !== ' ' && e.key !== 'Enter')) return;
              e.preventDefault();

              var cell = $(this);
              var tr = cell.closest('tr');
              var docId = cell.data('docid');
              var qrCode = tr.find('td:first').text().trim();
              var reviewButton = tr.find('a.btn-primary');
              var isCurrentlyApproved = cell.attr('data-search') === 'True';

              if (isCurrentlyApproved) {
                  $.get('/check_sdi/' + qrCode, function(response) {
                      if (response.exists) {
                          showModal('Action Not Allowed', 'The asset was exported to Planon, so you cannot proceed it again.');
                      } else {
                          toggleApprovedStatus(docId, cell, reviewButton);
                      }
                  }).fail(function() {
                      showModal('Server Error', "Could not check the asset's export status.");
                  });
              } else {
                  toggleApprovedStatus(docId, cell, reviewButton);
              }
          });

          function toggleApprovedStatus(docId, cell, reviewButton) {
              $.post('/toggle_approved/' + docId, function (resp) {
                  if (resp.success) {
                      var tr = cell.closest('tr');
                      if (resp.new_value === "True") {
                          cell.html('‚úÖ');
                          cell.attr('data-search', 'True');
                          reviewButton.addClass('disabled');
                      } else {
                          cell.html('‚òê');
                          cell.attr('data-search', 'False');
                          reviewButton.removeClass('disabled');
                      }
                      table.row(tr).invalidate().draw(false);
                  } else {
                      showModal('Update Failed', resp.error || "An unknown error occurred.");
                  }
              }).fail(function() {
                  showModal('Server Error', 'Failed to communicate with the server to update the approved status.');
              });
          }
      });
    </script>

</body>
</html>

